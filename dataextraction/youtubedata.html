<script src="https://apis.google.com/js/api.js"></script>

<script>
  var GoogleAuth;
  var SCOPE = 'https://www.googleapis.com/auth/youtube.readonly';
  function handleClientLoad() {
    // Load the API's client and auth2 modules.
    // Call the initClient function after the modules load.
    gapi.load('client:auth2', initClient);
  }

  function initClient() {
    // Retrieve the discovery document for version 3 of Google Drive API.
    // In practice, your app can retrieve one or more discovery documents.

    // Initialize the gapi.client object, which app uses to make API requests.
    // Get API key and client ID from API Console.
    // 'scope' field specifies space-delimited list of access scopes.
    gapi.client.init({
        'apiKey': '[apiKey]',
        'clientId': '[clientId]',
        'scope': SCOPE
    }).then(function () {
      GoogleAuth = gapi.auth2.getAuthInstance();

      // Listen for sign-in state changes.
      GoogleAuth.isSignedIn.listen(updateSigninStatus);

      // Handle initial sign-in state. (Determine if user is already signed in.)
      var user = GoogleAuth.currentUser.get();
      setSigninStatus();

      gapi.client.load("https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest").then(function() {
        console.log("GAPI client loaded for API");
      }, function(err) {
          console.error("Error loading GAPI client for API", err);
      });

      // Call handleAuthClick function when user clicks on
      //      "Sign In/Authorize" button.
      $('#sign-in-or-out-button').click(function() {
        handleAuthClick();
      });
      $('#revoke-access-button').click(function() {
        revokeAccess();
      });
    });
  }

  function handleAuthClick() {
    if (GoogleAuth.isSignedIn.get()) {
      // User is authorized and has clicked 'Sign out' button.
      GoogleAuth.signOut();
    } else {
      // User is not signed in. Start Google auth flow.
      GoogleAuth.signIn();
    }
  }

  function revokeAccess() {
    GoogleAuth.disconnect();
  }

  function setSigninStatus(isSignedIn) {
    var user = GoogleAuth.currentUser.get();
    var isAuthorized = user.hasGrantedScopes(SCOPE);
    if (isAuthorized) {
      $('#sign-in-or-out-button').html('Sign out');
      $('#revoke-access-button').css('display', 'inline-block');
      $('#auth-status').html('You are currently signed in and have granted ' +
          'access to this app.');
    } else {
      $('#sign-in-or-out-button').html('Sign In/Authorize');
      $('#revoke-access-button').css('display', 'none');
      $('#auth-status').html('You have not authorized this app or you are ' +
          'signed out.');
    }
  }

  function updateSigninStatus(isSignedIn) {
    setSigninStatus();
  }

  function loadJSON(callback) {
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', 'MITOCW_playlists.json', true); // Replace 'my_data' with the path to your file
    xobj.onreadystatechange = function () {
          if (xobj.readyState == 4 && xobj.status == "200") {
            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
          }
    };
    xobj.send(null);
  }

  var playlistIds = [];
  loadJSON(function(response) {
    // Parse JSON string into object
    var list_playlists = JSON.parse(response);
    for(var i = 0; i < Object.keys(list_playlists).length; i++) {
      playlistIds[i] = Object.keys(list_playlists)[i];
    }
  });

  function readPlaylists(callback) {
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', 'playlists.json', true); // Replace 'my_data' with the path to your file
    xobj.onreadystatechange = function () {
          if (xobj.readyState == 4 && xobj.status == "200") {
            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
          }
    };
    xobj.send(null);
  }

  var done = [];
  var next = playlistIds[0];
  function execute() {
    readPlaylists(function(response) {
      // Parse JSON string into object
      // console.log(response);
      done = JSON.parse(response);
      next = playlistIds[done.length];

      // console.log(gapi.client.youtube);
      // Example 1: Use method-specific function
      var requestVideoIds = gapi.client.youtube.playlistItems.list({
        "part": "snippet, contentDetails",
        "playlistId": next,
        "maxResults": 50
      })

      // Execute the API request.
      requestVideoIds.execute(function(response) {
        //consists of videos in playlist
        var videos = [];
        for(var i = 0; i < response['items'].length; i++) {
          var snippet = response['items'][i]['snippet'];
          snippet = {
            videoId : snippet['resourceId']['videoId']
          };
          videos[i] = snippet;
        }

        done[done.length] = {
          playlist: next,
          videos: videos
        }
        console.log(JSON.stringify(done));
      });
    });
  }

  function iterateexecute() {
    var i = 0;
    execute();
    var interval = setInterval(function() {
      next = playlistIds[done.length];

      // console.log(gapi.client.youtube);
      // Example 1: Use method-specific function
      var requestVideoIds = gapi.client.youtube.playlistItems.list({
        "part": "snippet, contentDetails",
        "playlistId": next,
        "maxResults": 50
      })

      // Execute the API request.
      requestVideoIds.execute(function(response) {
        //consists of videos in playlist
        var videos = [];
        for(var i = 0; i < response['items'].length; i++) {
          var snippet = response['items'][i]['snippet'];
          snippet = {
            videoId : snippet['resourceId']['videoId']
          };
          videos[i] = snippet;
        }

        done[done.length] = {
          playlist: next,
          videos: videos
        }
        console.log(JSON.stringify(done));
      });
      if(i > 250) {
        clearInterval(interval);
      }
      i++;
    }, 100);
  }


  // --------------- download Transcripts ------------------
  // get data from transcripts.json
  function checkTranscripts(callback) {
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', 'transcripts.json', true); // Replace 'my_data' with the path to your file
    xobj.onreadystatechange = function () {
          if (xobj.readyState == 4 && xobj.status == "200") {
            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
          }
    };
    xobj.send(null);
  }

  var next_video = 0; //default
  var next_playlist = null;
  var downloaded_transcripts = {};
  var allPlaylists = null;
  function pulltranscripts() {
    readPlaylists(function(response) {
      allPlaylists = JSON.parse(response);
      next_playlist = Object.keys(allPlaylists)[0];  //default
    });

    checkTranscripts(function(response) {
      // Parse JSON string into object
      // console.log(response);
      downloaded_transcripts = JSON.parse(response);
      //get next index
      try {
        for(var i = 0; i < downloaded_transcripts.length; i++) { // each playlist
          next_playlist = Object.keys(allPlaylists)[i];
          downloaded_transcripts[next_playlist] = [];
          for(var q = 0; q < downloaded_transcripts[i]; q++) {
            next_video++;
            downloaded_transcripts[next_playlist].push(allPlaylists[next_playlist]['videos'][next_video]['videoId']);
          }
        }
      } catch(err) {
        if(typeof downloaded_transcripts[next_playlist] == 'undefined') {
          downloaded_transcripts[next_playlist] = [];
        }
        downloaded_transcripts[next_playlist].push(allPlaylists[next_playlist]['videos'][next_video]['videoId']);
      }


      // Example 1: Use method-specific function
      var requestCaptionTracks = gapi.client.youtube.captions.list({
        "part": "snippet",
        "videoId": allPlaylists[next_playlist]['videos'][next_video]['videoId']
      })

      // Execute the API request.
      requestCaptionTracks.execute(function(tracks) {
        //consists of videos in playlist
        var captionId = null;
        var softSave = null;
        for(var i = 0; i < tracks.items.length; i++) {
          if(tracks.items[i].snippet.language == "en") {
            if(tracks.items[i].snippet.trackKind == 'ASR') {
              softSave = tracks.items[i].id;
            }
            if(tracks.items[i].snippet.trackKind == 'standard') {
              captionId = tracks.items[i].id;
            }
          }
        }
        if(captionId == null) {
          captionId = softSave;
        }

        // download transcript
        if(captionId != null) {
          var xobj = new XMLHttpRequest();
              xobj.overrideMimeType("application/json");
          xobj.open('GET', 'transcript.php?captionId='+captionId, true); // Replace 'my_data' with the path to your file
          xobj.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
          xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                  // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                  console.log(xobj.responseText);
                }
          };
          xobj.send(null);
        }


      });


    });
  }

</script>

<button id="sign-in-or-out-button"
        style="margin-left: 25px">Sign In/Authorize</button>
<button id="revoke-access-button"
        style="display: none; margin-left: 25px">Revoke access</button>

<button onclick="iterateexecute();">Pull Video IDs</button>

<button onclick="pulltranscripts();">Pull Video Transcripts</button>

<div id="auth-status" style="display: inline; padding-left: 25px"></div><hr>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>
